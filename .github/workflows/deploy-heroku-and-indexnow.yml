name: Deploy to Heroku + IndexNow

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

concurrency:
  group: deploy-heroku
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # Deploy to Heroku via git push
      - name: Deploy to Heroku
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git remote add heroku "https://heroku:${HEROKU_API_KEY}@git.heroku.com/${HEROKU_APP_NAME}.git"
          git push heroku HEAD:main --force

      - name: Generate IndexNow URLs from sitemap
        run: |
          node scripts/generate-indexnow-from-sitemap.mjs
          if [ ! -f "indexnow-urls.json" ]; then
            echo "indexnow-urls.json was not generated"
            exit 1
          fi
          echo "Generated indexnow-urls.json:"
          wc -l indexnow-urls.json || true

      - name: Submit IndexNow URLs
        env:
          INDEXNOW_INTERNAL_SECRET: ${{ secrets.INDEXNOW_INTERNAL_SECRET }}
          INDEXNOW_SUBMIT_URL: ${{ secrets.INDEXNOW_SUBMIT_URL }}
        run: |
          curl -sS -X POST "${INDEXNOW_SUBMIT_URL}" \
            -H "Content-Type: application/json" \
            -H "x-internal-secret: ${INDEXNOW_INTERNAL_SECRET}" \
            --data-binary @indexnow-urls.json | tee indexnow-response.json

      - name: Print IndexNow response
        run: cat indexnow-response.json
